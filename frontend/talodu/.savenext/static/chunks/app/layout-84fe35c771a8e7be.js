(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{15685:()=>{},17732:(e,t,r)=>{Promise.resolve().then(r.t.bind(r,15685,23)),Promise.resolve().then(r.bind(r,70398)),Promise.resolve().then(r.t.bind(r,50316,23))},50316:()=>{},70398:(e,t,r)=>{"use strict";r.d(t,{A:()=>i,AuthProvider:()=>c});var o=r(95155),a=r(12115),l=r(23464),s=r(87358);let n=(0,a.createContext)(void 0),c=e=>{let{children:t}=e,[r,c]=(0,a.useState)(null),[i,u]=(0,a.useState)(null),[h,d]=(0,a.useState)(!0),[_,m]=(0,a.useState)(!1);(0,a.useEffect)(()=>{let e=async()=>{let e=localStorage.getItem("j_auth_token"),t=localStorage.getItem("j_user");if(e&&t){u(e);try{let r=JSON.parse(t);c(r),l.A.defaults.headers.common.Authorization=`Bearer ${e}`}catch(e){console.error("Failed to parse stored user or validate token, or data corrupted:",e),g()}}else delete l.A.defaults.headers.common.Authorization;d(!1),m(!0)};_||e()},[_]),(0,a.useEffect)(()=>{i?l.A.defaults.headers.common.Authorization=`Bearer ${i}`:delete l.A.defaults.headers.common.Authorization},[i]);let g=(0,a.useCallback)(()=>{localStorage.removeItem("j_auth_token"),localStorage.removeItem("j_user"),localStorage.removeItem("j_refresh_token"),u(null),c(null)},[]),f=(0,a.useCallback)(()=>{console.log("Loading data in load data...");let e=localStorage.getItem("j_auth_token"),t=localStorage.getItem("j_user");if(e&&t){u(e);try{c(JSON.parse(t))}catch(e){console.error("Failed to parse user data from localStorage in loaddata",e),g()}}},[g]),k=(0,a.useCallback)(async(e,t,r)=>{try{let o=await l.A.post(r+"/login",{email:e,password:t}),{access_token:a,refresh_token:s,user:n}=o.data;return u(a),c(o.data.user),localStorage.setItem("j_auth_token",a),localStorage.setItem("j_refresh_token",s),localStorage.setItem("j_user",JSON.stringify(n)),n}catch(e){throw console.log("Login failed",e),e}},[]),A=(0,a.useCallback)(async()=>{console.log("... in Refresh token.., ");try{let e=localStorage.getItem("j_refresh_token");if(!e)throw g(),Error("No refresh token available. Logging out.");let t=s.env.NEXT_PUBLIC_API_BASE_URL;if(!t)throw Error("NEXT_PUBLIC_API_BASE_URL is not defined.");let{access_token:r,refresh_token:o}=(await l.A.post(t+"/refresh",{refresh_token:e})).data;return localStorage.setItem("j_auth_token",r),localStorage.setItem("j_refresh_token",o),r}catch(e){throw console.error("Error refreshing token:",e),g(),e}},[g]);(0,a.useEffect)(()=>{let e=l.A.interceptors.response.use(e=>e,async e=>{let t=e.config;if(console.log("... in interceptor, "),e.response?.status===401&&!t._retry){console.log("Got 401 in interceptor, trying to refresh token"),t._retry=!0;try{let e=await A();return t.headers.Authorization=`Bearer ${e}`,(0,l.A)(t)}catch(e){return Promise.reject(e)}}return Promise.reject(e)});return()=>{l.A.interceptors.response.eject(e)}},[A]);let S=(0,a.useCallback)(e=>!!r&&r.Roles?.some(t=>t.Name===e),[r]),I=(0,a.useCallback)(e=>!!r&&r.Roles?.some(t=>e.includes(t.Name)),[r]),j=(0,a.useCallback)(e=>!!r&&r.ID==e.owner.ID,[r]),p=(0,a.useCallback)(e=>!!r&&e?.Employees.some(e=>e.id===r.id),[r]);return(0,o.jsx)(n.Provider,{value:{user:r,token:i,loading:h,login:k,logout:g,hasRole:S,hasAnyRole:I,loaddata:f,isShopOwner:j,isShopEmployee:p},children:h?(0,o.jsx)("div",{children:"Authenticating..."}):t})},i=()=>{let e=(0,a.useContext)(n);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}}},e=>{var t=t=>e(e.s=t);e.O(0,[740,885,464,441,684,358],()=>t(17732)),_N_E=e.O()}]);